<#
Written by:  Ofir Gavish
Date:        2024-16-10

.SYNOPSIS
This script checks Azure AD applications for expiring secrets and certificates. 
It sends email notifications for secrets and certificates that are expiring within 
30, 10, or 5 days.

.DESCRIPTION
The script retrieves all Azure AD applications and their associated secrets and 
certificates. It calculates the remaining days until expiration and sends an 
email notification if any secrets or certificates are set to expire within 
the specified thresholds. The script can be scheduled to run automatically.

.PARAMETER DaysUntilExpiration
Defines the threshold for filtering applications by expiration days.

.PARAMETER IncludeAlreadyExpired
Specifies whether to include applications with already expired secrets and certificates.

.EXAMPLE
Run the script to receive notifications for any expiring secrets or certificates.

#>
Connect-MgGraph -ManagedIdentity

# Configuration
$DaysUntilExpiration = 30  # Change this as needed
$IncludeAlreadyExpired = 'No'  # Set to 'Yes' if you want to include already expired secrets
$EmailParams = @{
    SmtpServer = 'smtp.yourserver.com'
    From       = 'you@example.com'
    To         = 'recipient@example.com'
    Subject    = 'Secret Expiration Warning'
    Body       = ''
}

$Now = Get-Date
$Applications = Get-MgApplication -all

foreach ($App in $Applications) {
    $AppName = $App.DisplayName
    $AppID   = $App.Id

    $AppCreds = Get-MgApplication -ApplicationId $AppID |
        Select-Object PasswordCredentials, KeyCredentials

    # Check password credentials
    foreach ($Secret in $AppCreds.PasswordCredentials) {
        $RemainingDaysCount = ($Secret.EndDateTime - $Now).Days

        if (($IncludeAlreadyExpired -eq 'No' -and $RemainingDaysCount -ge 0) -or 
            ($IncludeAlreadyExpired -eq 'Yes')) {
            if ($RemainingDaysCount -le $DaysUntilExpiration) {
                if ($RemainingDaysCount -eq 30 -or $RemainingDaysCount -eq 10 -or $RemainingDaysCount -eq 5) {
                    $EmailParams.Body += "Warning: The secret '$($Secret.DisplayName)' for application '$AppName' will expire in $RemainingDaysCount days.`n"
                }
            }
        }
    }

    # Check key credentials
    foreach ($Cert in $AppCreds.KeyCredentials) {
        $RemainingDaysCount = ($Cert.EndDateTime - $Now).Days

        if (($IncludeAlreadyExpired -eq 'No' -and $RemainingDaysCount -ge 0) -or 
            ($IncludeAlreadyExpired -eq 'Yes')) {
            if ($RemainingDaysCount -le $DaysUntilExpiration) {
                if ($RemainingDaysCount -eq 30 -or $RemainingDaysCount -eq 10 -or $RemainingDaysCount -eq 5) {
                    $EmailParams.Body += "Warning: The certificate '$($Cert.DisplayName)' for application '$AppName' will expire in $RemainingDaysCount days.`n"
                }
            }
        }
    }
}

# Send email if there are any warnings
if ($EmailParams.Body) {
    Send-MailMessage @EmailParams
}
